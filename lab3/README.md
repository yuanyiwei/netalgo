# DPDK-DNS

lab3, SimpleDNS using DPDK.

## 简介

- 这里给出实验三的参考代码框架，server-main.c 是唯一需要修改的部分。
- SimpleDNS.h 包含原生 SimpleDNS 封装好的子函数，可以直接进行调用。

## 具体内容

- 本代码给出了 DPDK-DNS 的一种实现方式，其中有些关于 DPDK 的关键代码没有给出，可以在原代码的基础上实现，也可以按照自己的思路去实现。
- 参考代码思路：
  - DPDK 接收网卡的包，将不是 DNS 请求的包过滤掉。
  - 对 DNS 请求包构造相应的 Message 数据结构，并根据代码内存储的表给出查询结果，填充到 Message 中。
  - 根据填充了 answer 的 Message 构造应答包内容。
  - 根据查询包首部构造应答包首部。
  - 构造整个应答包并发送。
- 说明：lab3 仅做单线程上的性能优化。且本方案是一个较为直观的方案，具体的更高性能方案可以采用：
  - 例如 brust 收发多个包，调整某些收发队列长度或各种阈值，代码中减少拷贝次数等提高性能，具体的需要自己去想（可以参考教材第六章和第七章）。

## 使用方式

```shell
make
sudo ./build/app/server-main
```

## 注意事项

- 一个参考的在虚拟机上的测试方案：
  - 两台虚拟机，每个虚拟机配置三张网卡，其中 0 号网卡配置为 NAT 模式用于联网，1 号和 2 号网卡配置为桥接网卡模式，并映射为同一张物理网卡。
  - 给每台虚拟机的 1 号和 2 号网卡配置合适的 ip 地址，使其在同一个网段下，并相互之间可以 ping 通。
  - 设置使用 tcpdump 或者 wireshark 进行抓包可以发现，1 号和 2 号网卡由于映射的同一张物理网卡，收发包完全一致。
  - 0 号虚拟机 1 号网卡不动（Linux 内核驱动），2 号网卡配置上 DPDK 的驱动，并运行 server-main 程序。
  - 0 号虚拟机作为服务器，1 号虚拟机使用 dig 命令发包，dig 的目的 ip 地址为 0 号虚拟机的 1 号网卡 ip，保证服务端程序运行正常，dig 请求可以收到正确的应答。
  - 实验过程可以在虚拟机上安装 wireshark 对 1 号网卡进行抓包，也可以使用 tcpdump 抓包进行调试。
- 可以先使用原生 SimpleDNS 程序进行测试，抓包并对收发包进行分析和理解，理解 DNS 包的结构以及 ethernet，ip 和 udp 首部的含义。
- 在编程实现时注意别发生内存泄露，申请的内存要计时回收（尤其要注意由于分支语句造成的内存泄露现象），否则程序会卡死。
- 在收发包解析和拼接时，要注意主机序和字节序的转换，多使用抓包软件观察调试，观察与预期是否一致。
- 注意应答包 ip 头 DF 字段要置 1。（这种细节可以通过先运行原生 SimpleDNS 抓包后发现）
- 注意每个首部的字段长度。（例如首部某些字段需要知道整个数据包的长度，所以需要先拼凑出 DPDK 应答包的数据部分，再构造首部）

## 关于提交

- 设计思路文档
  - 截止时间：11 月 7 日 23:59
  - 提交内容：关于原生 SimpleDNS 的简单解读，以及使用 DPDK 加速 SimpleDNS 的思路文档。
  - 思路的表达形式：伪代码或流程图或文本。
  - 提交单位：小组
- 虚拟机上测试完成
  - 截止时间：11 月 15 日 23:59
  - 提交内容：
    - 在两台虚拟机上，其中一台向另一台安装了 DPDK 驱动并运行着 server-main 程序的服务端的网卡发送 dig 命令，并收到正确应答的截图。
    - 项目源代码。
  - 提交单位：个人
- 在服务器上进行性能测试
  - 截止时间：11 月 22 日 23:59
  - 提交内容：待定
  - 提交单位：小组
- 提交方式：
  - ftp
  - ip：202.38.79.85
  - username：学号
  - password：学号
